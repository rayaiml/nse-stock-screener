<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NSE Stock Screener</title>

  <!-- TradingView -->
  <script src="https://s3.tradingview.com/tv.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
    }

    h2, h3 {
      margin-bottom: 5px;
    }

    #filters label {
      display: block;
      margin-bottom: 3px;
    }

    button {
      margin-top: 8px;
      padding: 5px 10px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #333;
      padding: 4px;
      text-align: center;
    }

    th {
      background-color: #eee;
    }

    #chart {
      margin-top: 20px;
      height: 500px;
    }
  </style>
</head>

<body>

<h2>NSE Stock Screener</h2>

<h3>Filters</h3>
<div id="filters">
  <label><input type="checkbox" id="f_adx" checked> ADX 22–30</label>
  <label><input type="checkbox" id="f_macd" checked> MACD &gt; Signal</label>
  <label><input type="checkbox" id="f_vol" checked> Volume &gt; Avg Volume</label>
  <label><input type="checkbox" id="f_ema21" checked> EMA14 &gt; EMA21</label>
  <label><input type="checkbox" id="f_ema35" checked> EMA14 &gt; EMA35</label>
  <label><input type="checkbox" id="f_bb" checked> Price &gt; BB Middle</label>
  <label><input type="checkbox" id="f_rsi" checked> RSI 40–55</label>
</div>

<button onclick="loadData()">Scan Stocks</button>

<table>
  <thead>
    <tr>
      <th>Stock</th>
      <th>RSI</th>
      <th>ADX</th>
      <th>MACD</th>
      <th>Volume</th>
      <th>Avg Vol</th>
      <th>BB</th>
      <th>Trend</th>
    </tr>
  </thead>
  <tbody id="tb">
    <tr>
      <td colspan="8">Click "Scan Stocks"</td>
    </tr>
  </tbody>
</table>

<div id="chart"></div>

<script>
const API_BASE = "https://nse-stock-screener.onrender.com/scan";

// ---------------- FETCH FROM BACKEND WITH FILTER FLAGS ----------------
function loadData() {
  const params = new URLSearchParams({
    adx: document.getElementById("f_adx").checked ? 1 : 0,
    macd: document.getElementById("f_macd").checked ? 1 : 0,
    volume: document.getElementById("f_vol").checked ? 1 : 0,
    ema21: document.getElementById("f_ema21").checked ? 1 : 0,
    ema35: document.getElementById("f_ema35").checked ? 1 : 0,
    bb: document.getElementById("f_bb").checked ? 1 : 0,
    rsi: document.getElementById("f_rsi").checked ? 1 : 0
  });

  fetch(`${API_BASE}?${params.toString()}`)
    .then(res => res.json())
    .then(data => renderTable(data))
    .catch(err => {
      console.error(err);
      alert("Backend error. Please try again.");
    });
}

// ---------------- RENDER TABLE ----------------
function renderTable(data) {
  const tb = document.getElementById("tb");
  tb.innerHTML = "";

  if (!data || data.length === 0) {
    tb.innerHTML =
      "<tr><td colspan='8'>No stocks match selected filters</td></tr>";
    return;
  }

  // show max 10 rows
  data.slice(0, 10).forEach(s => {
    tb.innerHTML += `
      <tr>
        <td>
          <a href="#" onclick="loadChart('${s.stock}')">${s.stock}</a>
        </td>
        <td>${s.rsi}</td>
        <td>${s.adx}</td>
        <td>${s.macd}</td>
        <td>${s.volume}</td>
        <td>${s.avg_volume}</td>
        <td>${s.bb}</td>
        <td>${s.trend}</td>
      </tr>
    `;
  });
}

// ---------------- AUTO RESCAN ON FILTER CHANGE ----------------
document.querySelectorAll("#filters input").forEach(cb => {
  cb.addEventListener("change", loadData);
});

// ---------------- TRADINGVIEW CHART ----------------
function loadChart(symbol) {
  document.getElementById("chart").innerHTML = "";

  new TradingView.widget({
    container_id: "chart",
    symbol: "NSE:" + symbol,
    interval: "D",
    autosize: true,
    studies: [
      "EMA@tv-basicstudies",
      "EMA@tv-basicstudies",
      "MACD@tv-basicstudies",
      "RSI@tv-basicstudies",
      "BB@tv-basicstudies"
    ]
  });
}
</script>

</body>
</html>
