<!DOCTYPE html>
<html>
<head>
<title>NSE Stock Screener</title>
<script src="https://s3.tradingview.com/tv.js"></script>
</head>
<body>

<h2>NSE Stock Screener</h2>
<h3>Filters</h3>
<div id="filters">
  <label><input type="checkbox" id="f_adx" checked> ADX 22–30</label><br>
  <label><input type="checkbox" id="f_macd" checked> MACD &gt; Signal</label><br>
  <label><input type="checkbox" id="f_vol" checked> Volume &gt; Avg Volume</label><br>
  <label><input type="checkbox" id="f_ema21" checked> EMA14 &gt; EMA21</label><br>
  <label><input type="checkbox" id="f_ema35" checked> EMA14 &gt; EMA35</label><br>
  <label><input type="checkbox" id="f_bb" checked> Price &gt; BB Middle</label><br>
  <label><input type="checkbox" id="f_rsi" checked> RSI 40–55</label>
</div>
<hr>
<button onclick="load()">Scan Stocks</button>

<table border="1">
<thead>
<tr>
<th>Stock</th><th>RSI</th><th>ADX</th><th>MACD</th>
<th>Volume</th><th>Avg Vol</th><th>BB</th><th>Trend</th>
</tr>
</thead>
<tbody id="tb"></tbody>
</table>

<div id="chart"></div>

<script>
let rawData = [];

function load(){
  fetch("https://nse-stock-screener.onrender.com/scan")
    .then(r => r.json())
    .then(data => {
      rawData = data;
      applyFilters();
    })
    .catch(err => {
      alert("Backend not ready. Try again.");
      console.error(err);
    });
}

function applyFilters(){
  const tb = document.getElementById("tb");
  tb.innerHTML = "";

  let filtered = rawData.filter(s => {

    if (document.getElementById("f_adx").checked) {
      if (!(s.adx >= 22 && s.adx <= 30)) return false;
    }

    if (document.getElementById("f_macd").checked) {
      if (s.macd !== "Yes") return false;
    }

    if (document.getElementById("f_vol").checked) {
      if (s.volume <= s.avg_volume) return false;
    }

    if (document.getElementById("f_rsi").checked) {
      if (!(s.rsi >= 40 && s.rsi <= 55)) return false;
    }

    return true;
  });

  if (!filtered.length) {
    tb.innerHTML = "<tr><td colspan='8'>No stocks currently meet your requirements</td></tr>";
    return;
  }

  filtered.forEach(s => {
    tb.innerHTML += `
      <tr>
        <td><a href="#" onclick="chart('${s.stock}')">${s.stock}</a></td>
        <td>${s.rsi}</td>
        <td>${s.adx}</td>
        <td>${s.macd}</td>
        <td>${s.volume}</td>
        <td>${s.avg_volume}</td>
        <td>${s.bb}</td>
        <td>${s.trend}</td>
      </tr>
    `;
  });
}
</script>

<script>
document.querySelectorAll("#filters input").forEach(cb => {
  cb.addEventListener("change", applyFilters);
});
</script>

</body>
</html>
