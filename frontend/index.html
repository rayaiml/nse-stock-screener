<!DOCTYPE html>
<html>
<head>
  <title>NSE Stock Screener</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
    tr:hover { background: #f9f9f9; cursor: pointer; }
    .filters label { display: block; margin: 4px 0; }
  </style>
</head>
<body>

<h1>NSE Stock Screener</h1>

<div class="filters">
  <h3>Filters</h3>
  <label><input type="checkbox" id="adx"> ADX (22â€“30)</label>
  <label><input type="checkbox" id="macd"> MACD > Signal</label>
  <label><input type="checkbox" id="ema"> EMA Alignment</label>
  <label><input type="checkbox" id="bb"> Above BB Middle</label>
  <label><input type="checkbox" id="volume"> Volume > Avg</label>

  <br>
  <button onclick="scan()">Scan Stocks</button>
  <button onclick="exportCSV()">Export CSV</button>
  <button onclick="exportExcel()">Export Excel</button>
</div>

<table>
  <thead>
    <tr>
      <th>Rank</th>
      <th>Stock</th>
      <th>Score</th>
      <th>RSI</th>
      <th>ADX</th>
      <th>MACD</th>
      <th>EMA</th>
      <th>BB</th>
      <th>Volume</th>
      <th>Trend</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<div id="chart" style="margin-top:30px;"></div>

<script src="https://s3.tradingview.com/tv.js"></script>

<script>
let lastData = [];

/* ---------- SAFE FORMATTERS ---------- */
function num(v, d = 2) {
  return (typeof v === "number") ? v.toFixed(d) : "-";
}
function txt(v) {
  return (v !== undefined && v !== null && v !== "") ? v : "-";
}

/* ---------- SCAN ---------- */
async function scan() {
  const params = new URLSearchParams({
    adx: adx.checked,
    macd: macd.checked,
    ema: ema.checked,
    bb: bb.checked,
    volume: volume.checked
  });

  const res = await fetch(`https://nse-stock-screener.onrender.com/scan?${params}`);
  const json = await res.json();

  const stocks = json.data || [];
  lastData = stocks;

  renderTable(stocks);
}

/* ---------- TABLE ---------- */
function renderTable(stocks) {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  if (stocks.length === 0) {
    tbody.innerHTML = `<tr><td colspan="10">No stocks found</td></tr>`;
    return;
  }

  stocks.slice(0, 10).forEach((s, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${txt(s.symbol)}</td>
      <td>${num(s.score)}</td>
      <td>${num(s.rsi)}</td>
      <td>${num(s.adx)}</td>
      <td>${txt(s.macd_signal)}</td>
      <td>${txt(s.ema_trend)}</td>
      <td>${txt(s.bb_position)}</td>
      <td>${txt(s.volume_ratio)}</td>
      <td>${txt(s.trend)}</td>
    `;
    tr.onclick = () => showChart(s.symbol);
    tbody.appendChild(tr);
  });
}

/* ---------- TRADINGVIEW ---------- */
function showChart(symbol) {
  document.getElementById("chart").innerHTML = "";
  new TradingView.widget({
    autosize: true,
    symbol: "NSE:" + symbol,
    interval: "D",
    container_id: "chart",
    theme: "light",
    indicators: ["RSI", "MACD", "BB"],
    style: 1,
    locale: "en"
  });
}

/* ---------- EXPORT ---------- */
function exportCSV() {
  let csv = Object.keys(lastData[0] || {}).join(",") + "\n";
  lastData.forEach(r => {
    csv += Object.values(r).join(",") + "\n";
  });
  download(csv, "stocks.csv");
}

function exportExcel() {
  exportCSV(); // Excel opens CSV fine
}

function download(text, file) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text]));
  a.download = file;
  a.click();
}
</script>

</body>
</html>
